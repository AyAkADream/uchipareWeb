<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

    <title>キャラクター側</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/8.7.1/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/8.7.1/firebase-auth.js"></script>
    <script defer src="/__/firebase/8.7.1/firebase-database.js"></script>
    <script defer src="/__/firebase/8.7.1/firebase-firestore.js"></script>
    <script defer src="/__/firebase/8.7.1/firebase-functions.js"></script>
    <script defer src="/__/firebase/8.7.1/firebase-messaging.js"></script>
    <script defer src="/__/firebase/8.7.1/firebase-storage.js"></script>
    <script defer src="/__/firebase/8.7.1/firebase-analytics.js"></script>
    <script defer src="/__/firebase/8.7.1/firebase-remote-config.js"></script>
    <script defer src="/__/firebase/8.7.1/firebase-performance.js"></script>
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <script type="text/javascript" src="./jquery-3.6.0.min.js"></script>

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/style.css">
  </head>
  <body>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="/__/firebase/8.7.1/firebase-app.js"></script>
    <script src="/__/firebase/8.7.1/firebase-auth.js"></script>
    <script src="/__/firebase/8.7.1/firebase-database.js"></script>
    
    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="/__/firebase/8.7.1/firebase-analytics.js"></script>
    <!-- Initialize Firebase -->
    <script src="/__/firebase/init.js"></script>
    <script src="js/config.js"></script>

    <div class="bg_pattern3 Polka"></div>
    <div class="container">
      <ul class="nav justify-content-end mt-4 navbar-dark">
        <li class="nav-item">
            <a class="nav-link" href="index.html">TOP</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="pose_input.html">身体入力</a>
        </li>
        <li class="nav-item">
            <a class="nav-link  active" href="#">キャラクター側</a>
        </li>
      </ul>

      <div class="row mt-4 mb-4">
        <h1 class="posetitle2">ダンス作成</h1>
      </div>
      <div class="row mt-4 mb-4">
        <div class="col-md-1">
          <button class="Button-style3" type="button" onclick="startFunc()">Start</button>
        </div>
        <div class="col-md-11 mt-4">
          <h5>パレードが3秒後に開始します</h5>
        </div>
      </div>

      <!-- Blocklyのライブラリ -->
      <script src="blockly_compressed.js"></script>
      <script src="blocks_compressed.js"></script>
      <script src="javascript_compressed.js"></script>
      <script src="msg/js/ja.js"></script>
      <!-- 自作ブロックの定義 -->
      <script src="myblock.js"></script>

      <!-- knob -->
      <script src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="js/jquery.knob.js"></script>
      <script src="js/index.js"></script>

      <div class="row mt-4 mb-4">
        <div id="myButtons" class="btn-group" role="group" aria-label="Basic radio toggle button group">
          <input type="radio" class="btn-check  active" name="btnradio" id="btnradio1" autocomplete="off" checked>
          <label class="btn btn btn-outline-dark" for="btnradio1">Dancer 1</label>
        
          <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off">
          <label class="btn btn btn-outline-dark" for="btnradio2">Dancer 2</label>
        
          <input type="radio" class="btn-check" name="btnradio" id="btnradio3" autocomplete="off">
          <label class="btn btn btn-outline-dark" for="btnradio3">Dancer 3</label>
        </div>
      </div>
      <div class="row mt-4 mb-4">
        <h1><div id="c1Area_text"></div></h1>
        <h1><div id="c2Area_text"></div></h1>
        <h1><div id="c3Area_text"></div></h1>
      </div>

      <div class="row mt-4 mb-4">
        <div class="col-md-8">
          <!-- ワークスペースのエリア -->
          <div id="blocklyDiv" style="height: 480px; width: 100%;"></div>
          <!-- ツールボックスの定義 -->
          <xml id="toolbox" style="display: none">
            <category name="くりかえし">
              <block type="controls_repeat"></block>
            </category>
            <category name="dance1">
              <block type="dance1_l"></block>
              <block type="dance1_r"></block>
            </category>
            <category name="dance2">
              <block type="dance2_l"></block>
              <block type="dance2_r"></block>
            </category>
            <category name="dance3">
              <block type="dance3_1"></block>
              <block type="dance3_2"></block>
            </category>
            <category name="dance4">
              <block type="dance4_1"></block>
              <block type="dance4_2"></block>
            </category>
            <category name="dance5">
              <block type="dance5"></block>
            </category>
            <category name="dance6">
              <block type="dance6_l"></block>
              <block type="dance6_r"></block>
            </category>
            <category name="dance7">
              <block type="dance7_l"></block>
              <block type="dance7_r"></block>
            </category>
            <category name="dance8">
              <block type="dance8_1_l"></block>
              <block type="dance8_1_r"></block>
              <block type="dance8_2"></block>
            </category>
          </xml> 
        </div>
        <div class="col-md-4 mt-5">
          <!-- knob -->
          <div class="ml-5 mt-3">
          <div id="dial_1"><input type="text" value="0" class="dial"></div>
          <div id="dial_2"><input type="text" value="0" class="dial"></div>
          <div id="dial_3"><input type="text" value="0" class="dial"></div>
        </div>
      </div>
      </div>
      <button class="Button-style mb-4" id="runCode">ダンスの登録</button>
      </div>
    <script>

      var dancer_id = "btnradio1";
      dialDisplay();
      //Dancer選択
      $("#myButtons :input").change(function() {
          //console.log(this.id);
          dancer_id = this.id;
          //console.log(dancer_id);
          dialDisplay();
      });

      function dialDisplay(){
        const dial1_id = document.getElementById("dial_1");
        const dial2_id = document.getElementById("dial_2");
        const dial3_id = document.getElementById("dial_3");

        const c1Area_Text = document.getElementById("c1Area_text");
        const c2Area_Text = document.getElementById("c2Area_text");
        const c3Area_Text = document.getElementById("c3Area_text");
        
        if(dancer_id=="btnradio1"){
          dial1_id.style.display = "block";
          dial2_id.style.display = "none";
          dial3_id.style.display = "none";

          c1Area_Text.style.display = "block";
          c2Area_Text.style.display = "none";
          c3Area_Text.style.display = "none";

        } else if(dancer_id=="btnradio2"){
          dial1_id.style.display = "none";
          dial2_id.style.display = "block";
          dial3_id.style.display = "none";

          c1Area_Text.style.display = "none";
          c2Area_Text.style.display = "block";
          c3Area_Text.style.display = "none";

        } else if(dancer_id=="btnradio3"){
          dial1_id.style.display = "none";
          dial2_id.style.display = "none";
          dial3_id.style.display = "block";

          c1Area_Text.style.display = "none";
          c2Area_Text.style.display = "none";
          c3Area_Text.style.display = "block";
        }
      }

      //ワークスペースのエリア
      const workspace = Blockly.inject(
        'blocklyDiv',
        {
          toolbox: document.getElementById('toolbox'),
          trashcan: true,
        },
      );

      function runCode() {
        const code = Blockly.JavaScript.workspaceToCode(workspace);

        //プログラムを実行
        try{
          console.log(code);
          eval(code);
          console.log("配列",array1);
          updateDanceData(array1);
        }
        catch(e){
          alert(e);
        }
      }
      document.getElementById('runCode').addEventListener('click', runCode, false);

      //データベース
      var database = firebase.database();

      function writeDanceData(danceName) {
          database.ref('danceName/' + danceName).set({
          });
      }

      function writeDanceSet(dancerNum , danceSet, angle) {
          database.ref('dancerNum/' + dancerNum).set({
            danceSet:danceSet,
            angle:angle
          });
      }

      writeDanceData("dance_data1");
      writeDanceSet("dancer1", "0",0);

      writeDanceData("dance_data2");
      writeDanceSet("dancer2", "0",0);

      writeDanceData("dance_data3");
      writeDanceSet("dancer3", "0",0);

      function writeAreaSet(characterNum,areaName) {
          database.ref('characterNum/' + characterNum).set({
            areaName:areaName
          });
      }

      writeAreaSet('c1','アワー・グラス・プラザ');
      writeAreaSet('c2','アワー・グラス・プラザ');
      writeAreaSet('c3','アワー・グラス・プラザ');

      c1Area_Text = document.getElementById("c1Area_text");
      c2Area_Text = document.getElementById("c2Area_text");
      c3Area_Text = document.getElementById("c3Area_text");

      //c1Area_Text.innerHTML = "areaC0";
      var c1;
      database.ref('characterNum').child('c1').child('areaName').on('value',function(snapshot) {c1 = snapshot.val()})
      c1Area_Text.innerHTML = c1;
      //c2Area_Text.innerHTML = "areaC0";
      var c2;
      database.ref('characterNum').child('c2').child('areaName').on('value',function(snapshot) {c2 = snapshot.val()})
      c2Area_Text.innerHTML = c2;
      //c3Area_Text.innerHTML = "areaC0";
      var c3;
      database.ref('characterNum').child('c3').child('areaName').on('value',function(snapshot) {c3 = snapshot.val()})
      c3Area_Text.innerHTML = c3;

      database.ref('characterNum').child('c1').on('child_changed',function(snapshot) {
        var c1_data = snapshot.val();
        console.log(c1_data);
        c1Area_Text.innerHTML = c1_data;
      })

      database.ref('characterNum').child('c2').on('child_changed',function(snapshot) {
        var c2_data = snapshot.val();
        console.log(c2_data);
        c2Area_Text.innerHTML = c2_data;
      })

      database.ref('characterNum').child('c3').on('child_changed',function(snapshot) {
        var c3_data = snapshot.val();
        console.log(c3_data);
        c3Area_Text.innerHTML = c3_data;
      })

      function updateDanceData(array){
        if(dancer_id=="btnradio1"){
          database.ref('dancerNum').child('dancer1').update({danceSet:'1'});
          for(i=0;i<array1.length;i++){
            database.ref('danceName').child('dance_data1').push(array[i]);
          }
          array1.length=0;
        }else if(dancer_id=="btnradio2"){
          database.ref('dancerNum').child('dancer2').update({danceSet:'1'});
          for(i=0;i<array1.length;i++){
            database.ref('danceName').child('dance_data2').push(array[i]);
          }
          array1.length=0;
        }else if(dancer_id=="btnradio3"){
          database.ref('dancerNum').child('dancer3').update({danceSet:'1'});
          for(i=0;i<array1.length;i++){
            database.ref('danceName').child('dance_data3').push(array[i]);
          }
          array1.length=0;
        }else{
          console.log("エラー");
        }
      }

      function updateAngle(angle){
        if(dancer_id=="btnradio1"){
          database.ref('dancerNum').child('dancer1').update({angle:angle});

        }else if(dancer_id=="btnradio2"){
          database.ref('dancerNum').child('dancer2').update({angle:angle});
    
        }else if(dancer_id=="btnradio3"){
          database.ref('dancerNum').child('dancer3').update({angle:angle});
    
        }else{
          console.log("エラー");
        }
      }

      $(function () {
          $('.dial').knob({
              min: "0",      //最小値
              max: "360",    //最大値
              width:"300",
              height:"300",
              "inputColor" : "#000000",
              "fgColor":"#faca7b",
              "bgColor" : "#ffffff",
              angleOffset:180,
              change: function (value) {
                  //console.log(parseInt(value));
                  updateAngle(parseInt(value));
              }
          });
      });

      function writeStartData(startName, startData){
        database.ref('startData/' + startName).set({
              start:startData
        });
      }
      writeStartData("startB","0");

      //スタートのデータベース
      function startFunc(){
        database.ref('startData').child('startB').update({start:'1'});
      }

    </script>
  </body>
</html>
